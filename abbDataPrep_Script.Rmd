---
title: "AirBNB Data Preparation and Imputation"
output: html_notebook
---

### Introduction

This file details the initial data preparation that we have applied to the AirBNB nightly data from www.AirDNA.co as well as to the long-term rental data from Australia Property Monitors (APM). This is not a 'data cleaning' exercise as we are not removing data points based on observed values.

&nbsp;
&nbsp;

### Setup

We begin by loading the necessary libraries, set the path to the data and loading a set of custom data munging functions. 

```{r message=FALSE, warning=FALSE, comment=FALSE, echo=TRUE}

 ## Load libraries
 
  library(spdep)
  library(maptools)
  library(gstat)
  library(ggplot2)
  library(ggmap)
  library(xtable)
  library(chron)
  library(RColorBrewer)
  library(plyr)
  library(stringr)

 ## Set location

  # Get computer names
  comp.name <- Sys.info()['nodename']

  # Assign path based on computer name
  if(comp.name == '7020D-121777-W' | 
      comp.name == 'DESKTOP-1D7JO4J'){
  
      data.path <- 'c:/dropbox/research/airBNB/data/'

  } else {
    
      data.path <- 'other path'
  
  }

 ## Load sources

  source("c:/code/research/airbnbMelbourne/dataPrep_Functions.R")

```

&nbsp;
&nbsp;

## Short Term (Airbnb) Data

We begin the data preparation with the Airbnb data.

### Load data

Next we load the raw property level and nightly level AirBNB reservation data received from AirDNA.  

```{r message=FALSE, warning=FALSE, comment=FALSE, echo=TRUE, cache=TRUE}

 ## Property Information

  prop.data <- read.csv(paste0(data.path, '/raw/melbproperties.csv'), header=T)

  ## Daily rental information

  daily.data  <- read.csv(paste0(data.path, '/raw/melbDaily.csv'), header=T)

```

&nbsp;
&nbsp;

### Data Transformations

To make future coding easier, we convert all field names to lower case.

```{r message=FALSE, warning=FALSE, comment=FALSE, echo=TRUE, cache=TRUE}

  names(prop.data) <- tolower(names(prop.data))
  names(daily.data) <- tolower(names(daily.data))

```

We also then convert date values into correct R formatted dates. We also create a year created variable for the property data. 

```{r message=FALSE, warning=FALSE, comment=FALSE, echo=TRUE, cache=TRUE}

 ## Daily data

  daily.data$date <- as.Date(daily.data$date)

 ## Property level data

  prop.data$created.date <- as.Date(prop.data$created.date)
  prop.data$created.year <- as.numeric(substr(prop.data$created.date, 1, 4))
  
```

&nbsp;
&nbsp;

### Add Summary Information

We now add summary information regarding the number of bookings, number of free and blocked nights to the property level data.  This information will assist in future imputation exercises and other analyses. 

We start by splitting the daily date into a list where each object is a data.frame of daily observations for a particular property. 

```{r message=FALSE, warning=FALSE, comment=FALSE, echo=TRUE, cache=TRUE}
  
  daily.prop <- split(daily.data, daily.data$property.id)

```

Next, we apply the **abbAnalyzeDaily()** function to each data.frame of daily observations. This process produces a list of results, by property.id.  These lists are then collapsed into a single data.frame.

```{r message=FALSE, warning=FALSE, comment=FALSE, echo=TRUE, cache=TRUE}

  daily.summ.list <- lapply(daily.prop, abbAnalyzeDaily)
  daily.summ <- rbind.fill(daily.summ.list)

```

Finally, we add the summarized data to the existing property-level information.

```{r message=FALSE, warning=FALSE, comment=FALSE, echo=TRUE, cache=TRUE}

  prop.data <- merge(prop.data, daily.summ, by='property.id')

```

&nbsp;
&nbsp;

Finally, we write the amended daily and property data to .csv files for future analysis. 

```{r message=FALSE, warning=FALSE, comment=FALSE, echo=TRUE, cache=TRUE}

 write.csv(all.daily, paste0(data.path, 'prepared/dailydata.csv'), row.names=FALSE)

 write.csv(prop.data, paste0(data.path, 'prepared/propdata.csv'), row.names=FALSE)

```
