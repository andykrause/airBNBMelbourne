---
title: "5_data_viz"
author: "Andy Krause"
date: "May 10, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
  
  knitr::opts_chunk$set(echo = TRUE)

```

```{r set_paths, message=FALSE, warning=FALSE, comment=FALSE, echo=TRUE, results='hide'}

  library(tmap)
  library(magrittr)
  library(dplyr)
  library(ggplot2)

```

```{r load_data, message=FALSE, warning=FALSE, comment=FALSE, cache=TRUE, echo=FALSE, results='hide'}

  load(file.path(getwd(), 'data', 'analyzed', 'analyzed_data.RData'))

  dir.create(file.path(getwd(), 'images'))

  str_col = col_df$rgb[1]
    
```

## Suburb Location Map

```{r sub_loc.map, message=FALSE, warning=FALSE, comment=FALSE, cache=FALSE, echo=TRUE}
 
  # Set submarket colors
  suburb_sf$col <- 'gray80'
  suburb_sf$col[suburb_sf$class == 'Middle'] <- 'gray50'
  suburb_sf$col[suburb_sf$class == 'Inner'] <- 'gray20'
  
   # Make map
  
  png(filename = file.path(getwd(), 'images', "sub_loc_map.png"), 
       width = 6.5, height = 6.5, units = 'in', res = 300)

  tm_shape(suburb_sf) +
    tm_polygons("class", palette=c('gray20', 'gray50', 'gray80'), title='Suburb Class') +
  tm_shape(studyarea_sf) + 
    tm_borders(col='black', lwd=5) +
    tm_add_legend(type='fill', border.lwd=3, col='white', border.col='black',
                  title='Study Area')
  
  dev.off()  
  
```

## Point Location Maps

```{r location map}

  sm_col <- c(col_df$rgb[3], col_df$rgb[4], col_df$rgb[5], 
              col_df$rgb[6], col_df$rgb[1])
  
  png(filename = file.path(getwd(), 'images', "ltr_loc_map.png"), 
       width = 4, height = 4, units = 'in', res = 300)
  tm_shape(studyarea_sf) + 
    tm_borders(col='gray50', lwd=2) +
  tm_shape(suburb_sf %>% dplyr::filter(in_studyarea == 1)) +
    tm_borders(col='gray90', lwd=.5) +
  tm_shape(ltr_sf %>% dplyr::rename(Submarket = geo_mrkt)) +
    tm_symbols('Submarket', size=.02,
               palette = sm_col, alpha=.3, shape=16, legend.col.show=TRUE)
  dev.off()  
  
  png(filename = file.path(getwd(), 'images', "str_loc_map.png"), 
       width = 4, height = 4, units = 'in', res = 300)
  tm_shape(studyarea_sf) + 
    tm_borders(col='gray50', lwd=2) +
  tm_shape(suburb_sf %>% dplyr::filter(in_studyarea == 1)) +
    tm_borders(col='gray90', lwd=.5) +
  tm_shape(str_sf %>% dplyr::rename(Submarket = geo_mrkt)) +
    tm_symbols('Submarket', size=.02,
               palette = sm_col, alpha=.3, shape=16)
  dev.off()  
  


```

```{r smtype.plot, message=FALSE, warning=FALSE, comment=FALSE, cache=FALSE, echo=TRUE, fig.width=9}
 
   # Make Airbnb submarket map
   
   strtype_bar <- ggplot() +
     geom_bar(data=str_tdf, aes(x=geo_mrkt, fill=geo_mrkt)) +
     scale_fill_manual(values=sm_col, name='Submarket') +
     facet_wrap(~type) +
     ylab('# of Properties\n') + xlab('')+
     theme(legend.position = 'bottom',
           legend.title = element_blank(),
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank()) +
     ggtitle('Short Term Property Type\nBy Submarket')+
     theme(plot.title = element_text(hjust = 0.5))
   
   # Make Long term rental map
 
   ltrtype_bar <- ggplot() +
     geom_bar(data=ltr_tdf, aes(x=geo_mrkt, fill=geo_mrkt)) +
     scale_fill_manual(values=sm_col) +
     facet_wrap(~type) +
     ylab('# of Properties\n') + xlab('')+
     theme(legend.position = 'bottom',
           legend.title = element_blank(),
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank()) +
     ggtitle('Long Term Property Type\nBy Submarket')+
     theme(plot.title = element_text(hjust = 0.5))
   
     png(filename = file.path(getwd(), 'images', "loc_bar.png"), 
       width = 8, height = 4, units = 'in', res = 300)
 
     ggMultiPlots(strtype_bar, ltrtype_bar, cols=2)
     dev.off()  
 
       
```

```{r maps}

   dens_cols <- c(col_df$rgb[3], col_df$rgb[1], col_df$rgb[2])

   # Add together for plotting
   rev_df <- bind_rows(str_tdf %>% 
                         dplyr::select(type, revenue=lik_revenue_net) %>%
                         dplyr::mutate(tenure = 'Short Term (Likely)   ',
                                       alpha = .5),
                       str_tdf %>% 
                         dplyr::select(type, revenue=pot_revenue_net) %>%
                         dplyr::mutate(tenure = 'Short Term (Potential)   ',
                                       alpha = .4),
                       ltr_df %>%
                         dplyr::select(type, revenue=gross_revenue) %>%
                         dplyr::mutate(tenure = 'Long-Term   ',
                                       alpha = .9))

  png(filename = file.path(getwd(), 'images', "rev_dens.png"), 
       width = 5.5, height = 4, units = 'in', res = 300)
 
   ggplot(rev_df,
          aes(x=revenue, fill=tenure, color=tenure)) +
    geom_density(alpha=.5) +
    scale_fill_manual(values=dens_cols) +
    scale_color_manual(values=dens_cols) +
    ggtitle('Short Term Revenue vs Long Term Revenue') +
    xlab('Annual Revenue') +
    scale_x_continuous(breaks=c(seq(0,60000, by=20000)),
                       labels=c('$0', '$20,000', '$40,000', '$60,000'))+
    theme(legend.position='bottom',
          legend.title = element_blank(),
          plot.title = element_text(hjust = 0.5),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.title.y=element_blank()) +
    coord_cartesian(xlim=c(0, 70000))

    dev.off()  
        
```

Host type investigation

```{r host_types}

  png(filename = file.path(getwd(), 'images', "block_rate_hist.png"), 
       width = 5.5, height = 4, units = 'in', res = 300)

    ggplot(str_tdf, aes(x=block_rate)) + 
      geom_density(fill=str_col, color=str_col) +
      ylab('Frequency\n') + 
      xlab('\n% of Time Property is Blocked') +
      scale_x_continuous(breaks=seq(0,1,.2),
                         labels=c('0%', '20%', '40%', '60%', '80%', '100%')) +
        ggtitle('Host Block Rate Frequency\n') +
        theme(plot.title = element_text(hjust = 0.5)) +
        theme(axis.text.y=element_blank(),
              axis.ticks.y=element_blank())
  
  dev.off()  
      
  png(filename = file.path(getwd(), 'images', "block_periods_scat.png"), 
       width = 5.5, height = 4, units = 'in', res = 300)
   
  ggplot(str_tdf, aes(x=block_rate, y=nbr_block * (366/total_days))) + 
    geom_point(fill=str_col, color=str_col, size=.2) +
    ylab('Nbr of Blocked Periods\n') + 
    xlab('\n% of Time Property is Blocked') +
    scale_x_continuous(breaks=seq(0, 1, .2),
                       labels=c('0%', '20%', '40%', '60%', '80%', '100%')) +
    ggtitle('Block Rate vs. Nbr. of Blocked Periods\n') +
    theme(plot.title = element_text(hjust = 0.5)) 

  dev.off()  
  
  png(filename = file.path(getwd(), 'images', "host_type_scat.png"), 
       width = 5.5, height = 4, units = 'in', res = 300)
      
   ggplot(str_tdf, 
          aes(x=block_rate, y=blockpertime, color=host_type)) + 
     geom_point(alpha=.5, size=.8, shape=16) +
     ylab('Number of Blocked Periods\n') + 
     xlab('\n% of Time Property is Blocked') +
        ggtitle('Block Rate vs. Nbr. of Blocked Periods\n') +
 
      scale_x_continuous(breaks=seq(0, 1, .2),
                       labels=c('0%', '20%', '40%', '60%', '80%', '100%')) +
      scale_color_manual(values=c(col_df$rgb[2], col_df$rgb[4], col_df$rgb[7], 
                                  col_df$rgb[9])) + 
      theme(legend.position='bottom',
           legend.title = element_blank(),
         plot.title = element_text(hjust = 0.5))+
       guides(colour = guide_legend(override.aes = list(size=3,
                                                     alpha=1)))
 
   dev.off()  
      
```